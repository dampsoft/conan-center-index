From 1cc8162b5bb2de4a24c1e7e8652eb0767f2d47c2 Mon Sep 17 00:00:00 2001
From: Rasmus Thomsen <oss@cogitri.dev>
Date: Tue, 20 Dec 2022 12:42:14 +0100
Subject: [PATCH] Always require packes when their option is enabled

---
 CMakeLists.txt                               | 27 +++++++-------------
 cmake/modules/MacroOptionalFindPackage.cmake |  2 +-
 2 files changed, 10 insertions(+), 19 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index d1d3653a..9952ad9e 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -162,24 +162,15 @@ else()
 endif()
 
 if (ENABLE_QT5)
-  find_package(Qt5Core 5.9)  # Update QT_DISABLE_DEPRECATED_BEFORE in qt5/CMakeLists.txt when increasing this
-  find_package(Qt5Gui)
-  find_package(Qt5Xml)
-  find_package(Qt5Widgets)
-  find_package(Qt5Test)
-  if (NOT (Qt5Core_FOUND AND Qt5Gui_FOUND AND Qt5Xml_FOUND AND Qt5Widgets_FOUND AND Qt5Test_FOUND))
-    message("-- Package Qt5Core or Qt5Gui or Qt5Xml or Qt5Widgets or Qt5Test not found")
-    set(ENABLE_QT5 OFF)
-  endif()
+  find_package(Qt5Core 5.9 REQUIRED)  # Update QT_DISABLE_DEPRECATED_BEFORE in qt5/CMakeLists.txt when increasing this
+  find_package(Qt5Gui REQUIRED)
+  find_package(Qt5Xml REQUIRED)
+  find_package(Qt5Widgets REQUIRED)
 endif()
 
 if (ENABLE_QT6)
   SET(QT_NO_CREATE_VERSIONLESS_TARGETS ON)
-  find_package(Qt6 COMPONENTS Core Gui Widgets Test QUIET)
-  if (NOT (Qt6Core_FOUND AND Qt6Gui_FOUND AND Qt6Widgets_FOUND AND Qt6Test_FOUND))
-    message("-- Package Qt6Core or Qt6Gui or Qt6Widgets or Qt6Test not found")
-    set(ENABLE_QT6 OFF)
-  endif()
+  find_package(Qt6 COMPONENTS Core Gui Widgets REQUIRED)
 endif()
 
 # Check for Cairo rendering backend
@@ -240,7 +231,7 @@ if(ENABLE_CPP)
   set(HAVE_ICONV ${ICONV_FOUND})
 endif()
 if(ENABLE_ZLIB)
-  find_package(ZLIB)
+  find_package(ZLIB REQUIRED)
   set(ENABLE_ZLIB ${ZLIB_FOUND})
 endif()
 if(ENABLE_ZLIB_UNCOMPRESS AND NOT ENABLE_ZLIB)
@@ -249,7 +240,7 @@ if(ENABLE_ZLIB_UNCOMPRESS AND NOT ENABLE_ZLIB)
 endif()
 set(WITH_OPENJPEG FALSE)
 if(ENABLE_LIBOPENJPEG STREQUAL "openjpeg2")
-  find_package(OpenJPEG)
+  find_package(OpenJPEG REQUIRED)
   set(WITH_OPENJPEG ${OpenJPEG_FOUND})
   if(NOT OpenJPEG_FOUND OR OPENJPEG_MAJOR_VERSION VERSION_LESS 2)
     message(FATAL_ERROR "Install libopenjpeg2 before trying to build poppler. You can also decide to use the internal unmaintained JPX decoder or none at all.")
@@ -266,13 +257,13 @@ else()
 endif()
 set(ENABLE_LIBOPENJPEG "${WITH_OPENJPEG}")
 if(ENABLE_CMS STREQUAL "lcms2")
-  find_package(LCMS2)
+  find_package(LCMS2 REQUIRED)
   set(USE_CMS ${LCMS2_FOUND})
 elseif(NOT ENABLE_CMS STREQUAL "none")
   message(FATAL_ERROR "Invalid ENABLE_CMS value: ${ENABLE_CMS}")
 endif()
 if(ENABLE_LIBCURL)
-  find_package(CURL)
+  find_package(CURL REQUIRED)
   if(CURL_FOUND)
     include_directories(SYSTEM ${CURL_INCLUDE_DIR})
     set(POPPLER_HAS_CURL_SUPPORT ON)
diff --git a/cmake/modules/MacroOptionalFindPackage.cmake b/cmake/modules/MacroOptionalFindPackage.cmake
index d4ed48e3..ad1393ac 100644
--- a/cmake/modules/MacroOptionalFindPackage.cmake
+++ b/cmake/modules/MacroOptionalFindPackage.cmake
@@ -29,7 +29,7 @@ endmacro(_MOFP_SET_EMPTY_IF_DEFINED _package _var)
 macro (MACRO_OPTIONAL_FIND_PACKAGE _name )
    option(WITH_${_name} "Search for ${_name} package" ON)
    if (WITH_${_name})
-      find_package(${_name} ${ARGN})
+      find_package(${_name} ${ARGN} REQUIRED)
    else (WITH_${_name})
       string(TOUPPER ${_name} _nameUpper)
       set(${_name}_FOUND FALSE)
-- 
2.37.1 (Apple Git-137.1)

